---
layout:     post                   
title:      IM的消息送达保障模式             
date:       2018-03-06             
author:     Hearnseu                         
catalog: true                       
tags:                              
    - IM
---



即时通讯软件最怕的什么，消息发出去了对方没有收到，也就是消息在传输过程中丢失了，不少及时通讯协议都存在一定的丢失率，如XMPP。本文就这个问题探讨如何保障对方收到消息，并给己方提示。

### 1. 建立重发机制
把即将发出的消息包装一个重发消息里，加入当前时间，放入到重发队列里，是的，在发送前我们就做好重发的准备了。在消息发送成功(服务器确认发送成功)或收到对方发过来的收到应答后，我们将该消息从重发队列中移除。
**定时检查重发队列**
每隔1秒检查队列中的消息，如果消息的状态不是在发送中并且没有超时，那么就执行重发操作。此处也有例外，比如收到应答消息，必须要一直发送到成功为止，不然服务器以为你没有收到消息而重发。

### 2. 消息的表示与发送方式
**消息的表示**
不同的通讯协议会对聊天消息进行不同的处理，如XMPP协议把消息包装在XML结构中，造成了消息体的臃肿。在网络传输中，数据包越小，发送成功的概率就越大，因此好的即时通讯协议会把消息体压缩的越小越好。

在我们的方案中，消息通过protobuf进行处理，转换成二进制数据后发送。

**发送管道**
在我们的方案中，消息传输首选基于tcp socket的RPC，如果socket方式发送失败，则落到http方式，通过`post`方式向服务器发送数据。

**发送路径**
我们采取了使用服务器作为中介的架构，双方通过服务器收发消息, 简化了客户端的工作，将大多数工作放在服务器端进行，服务器承担了客户端信息记录、连接管理和信息的路由功能。

**离散型的发送**
每个消息的发送都会新建一个callback实例，在实例中通过`delegate`方式接收回调。

**消息的标识**
消息在发送前，会先保存到数据库，同时获取一个ID，这个ID是在发送过程中，查找消息，更新消息状态的唯一依据。

### 3. ack消息
在收到消息后，应当回复服务器，表示消息已收到，完成一个消息的接收流程。

### 4. 消息发送状态的处理
消息构建后存在数据库中或内存中有以下状态：

1. unSended, 未发送或发送失败
2. sending， 正在发送中
3. sended， 已发送
4. received， 对方已收到
5. readed， 对方已读

逻辑完整的状态管理在消息发送的流程中起到至关重要的作用。


